<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>项目中的一些问题 by hanl754</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">项目中的一些问题</h1>
      <h2 class="project-tagline">ConcurrentModificationException</h2>
      <a href="https://github.com/hanl754/issue" class="btn">View on GitHub</a>
      <a href="https://github.com/hanl754/issue/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/hanl754/issue/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h2>
<a id="今天在项目中报出concurrentmodificationexception参考httpstackoverflowcomquestions8189466java-util-concurrentmodificationexception总结一下这个问题出现的原因以及我的解决方法" class="anchor" href="#%E4%BB%8A%E5%A4%A9%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E6%8A%A5%E5%87%BAconcurrentmodificationexception%E5%8F%82%E8%80%83httpstackoverflowcomquestions8189466java-util-concurrentmodificationexception%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%E5%87%BA%E7%8E%B0%E7%9A%84%E5%8E%9F%E5%9B%A0%E4%BB%A5%E5%8F%8A%E6%88%91%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>今天在项目中报出<code>ConcurrentModificationException</code>。参考<a href="http://stackoverflow.com/questions/8189466/java-util-concurrentmodificationexception">http://stackoverflow.com/questions/8189466/java-util-concurrentmodificationexception</a>总结一下这个问题出现的原因以及我的解决方法。</h2>

<h3>
<a id="问题代码demo" class="anchor" href="#%E9%97%AE%E9%A2%98%E4%BB%A3%E7%A0%81demo" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>问题代码demo：</h3>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">RemoveListElementDemo</span> {
    <span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-k">List&lt;<span class="pl-smi">Integer</span>&gt;</span> integerList;
    <span class="pl-k">static</span> {
        integerList <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-k">ArrayList&lt;<span class="pl-smi">Integer</span>&gt;</span>();
        integerList<span class="pl-k">.</span>add(<span class="pl-c1">1</span>);
        integerList<span class="pl-k">.</span>add(<span class="pl-c1">2</span>);
        integerList<span class="pl-k">.</span>add(<span class="pl-c1">3</span>);
    }
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">remove</span>(<span class="pl-smi">Integer</span> <span class="pl-v">remove</span>) {
        <span class="pl-k">for</span>(<span class="pl-smi">Integer</span> integer <span class="pl-k">:</span> integerList) {
            <span class="pl-k">if</span>(integer<span class="pl-k">.</span>equals(remove)) {                
                integerList<span class="pl-k">.</span>remove(integer);
            }
        }
    }
    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">main</span>(<span class="pl-smi">String</span> <span class="pl-v">args</span>[]) { 
        <span class="pl-c">//ok       </span>
        remove(<span class="pl-c1">2</span>);
        <span class="pl-c">//java.util.ConcurrentModificationException</span>
        remove(<span class="pl-c1">3</span>);      
    }
}</pre></div>

<p>发现remove(2)没有问题但是下面删除3的时候报了<code>ConcurrentModificationException</code> 。</p>

<h3>
<a id="分析" class="anchor" href="#%E5%88%86%E6%9E%90" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>分析：</h3>

<p>原因：</p>

<ul>
<li>
<code>for(Object o : Collection c)</code>循环遍历的时候采用的是迭代器(Iterator)进行遍历.</li>
<li>iterator在建立并用其来遍历collection的时候，每次调用next()方法的时会检查这个collection是否被改动（如删除和增加操作），此改动是指collection自己的remove、add等操作。如果有这样的行为，则抛出<code>ConcurrentModificationException</code>。</li>
<li>当<code>iterator.hasNext()</code>为真时会调用next()方法，而hasNext()方法的内部逻辑是</li>
</ul>

<div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">boolean</span> hasNext() {
     <span class="pl-k">return</span> cursor <span class="pl-k">!=</span> size();
}</pre></div>

<p>实际情况分析：</p>

<ul>
<li>调用remove(2)的时候，cursor=2，删除2之后size为2，hasNext()不为真，循环停止，不会再取next故不会抛出异常。</li>
<li>如果注释掉remove(2)，即进行remove(3)操作，则会抛出<code>ConcurrentModificationException</code>异常，原因是cursor为3，size为2，iterator认为它还有next，所以调用next方法，此时触发了一次检查，发现collection被改动，抛出异常。</li>
</ul>

<h3>
<a id="问题解决" class="anchor" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>问题解决：</h3>

<p>如果在iterator进行迭代的时候进行collection的删操作，采用iterator.remove()方法是安全的。如果要增加元素的话，可以使用一份副本进行操作。</p>

<p>第一次写，有错请指正！</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/hanl754/issue">项目中的一些问题</a> is maintained by <a href="https://github.com/hanl754">hanl754</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
